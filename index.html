<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Component Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-group {
            @apply flex flex-col md:flex-row gap-2 items-center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Component Calculator</h1>
        
        <!-- Unit Toggle Button -->
        <div class="flex justify-end mb-4">
            <button id="unitToggleBtn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg text-sm font-medium hover:bg-gray-300 transition-colors duration-200">
                Switch to Inches
            </button>
        </div>

        <!-- Thigh Measurement Input -->
        <div class="mb-4">
            <label for="thighMeasurement" id="thighLabel" class="block text-sm font-medium text-gray-700 mb-2">Thigh Measurement (in cm):</label>
            <input type="number" id="thighMeasurement" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 25" min="0">
        </div>

        <!-- Shin Measurement Input -->
        <div class="mb-6">
            <label for="shinMeasurement" id="shinLabel" class="block text-sm font-medium text-gray-700 mb-2">Shin Measurement (in cm):</label>
            <input type="number" id="shinMeasurement" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 35" min="0">
        </div>

        <!-- Calculate Button -->
        <button id="calculateBtn" class="w-full py-3 px-6 bg-blue-600 text-white rounded-lg font-bold text-lg hover:bg-blue-700 transition-colors duration-200 shadow-md focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50">
            Calculate
        </button>

        <!-- Results Section -->
        <div id="results" class="mt-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Results:</h2>
            <div id="results-container" class="bg-gray-50 p-4 rounded-lg">
                <!-- Results will be displayed here -->
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden mt-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
            <p class="font-bold">Error:</p>
            <p id="errorText"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const thighMeasurementInput = document.getElementById('thighMeasurement');
            const shinMeasurementInput = document.getElementById('shinMeasurement');
            const calculateBtn = document.getElementById('calculateBtn');
            const unitToggleBtn = document.getElementById('unitToggleBtn');
            const thighLabel = document.getElementById('thighLabel');
            const shinLabel = document.getElementById('shinLabel');
            const resultsContainer = document.getElementById('results-container');
            const resultsSection = document.getElementById('results');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');

            let currentUnit = 'cm'; // Default unit

            calculateBtn.addEventListener('click', calculateMeasurements);
            unitToggleBtn.addEventListener('click', toggleUnit);

            function toggleUnit() {
                if (currentUnit === 'cm') {
                    currentUnit = 'inches';
                    unitToggleBtn.textContent = 'Switch to CM';
                    thighLabel.textContent = 'Thigh Measurement (in inches):';
                    shinLabel.textContent = 'Shin Measurement (in inches):';
                    thighMeasurementInput.placeholder = 'e.g., 9.84';
                    shinMeasurementInput.placeholder = 'e.g., 13.78';
                } else {
                    currentUnit = 'cm';
                    unitToggleBtn.textContent = 'Switch to Inches';
                    thighLabel.textContent = 'Thigh Measurement (in cm):';
                    shinLabel.textContent = 'Shin Measurement (in cm):';
                    thighMeasurementInput.placeholder = 'e.g., 25';
                    shinMeasurementInput.placeholder = 'e.g., 35';
                }
                // Clear inputs and results on unit change
                thighMeasurementInput.value = '';
                shinMeasurementInput.value = '';
                hideResults();
                hideError();
            }

            function convertToCm(value) {
                return value * 2.54;
            }

            function convertToInches(value) {
                return value / 2.54;
            }

            function calculateMeasurements() {
                hideResults();
                hideError();

                let thigh = parseFloat(thighMeasurementInput.value);
                let shin = parseFloat(shinMeasurementInput.value);

                if (isNaN(thigh) || thigh <= 0 || isNaN(shin) || shin <= 0) {
                    showError("Please enter valid measurements for both the thigh and shin. Values must be greater than 0.");
                    return;
                }

                if (currentUnit === 'inches') {
                    thigh = convertToCm(thigh);
                    shin = convertToCm(shin);
                }

                const totalMeasurement = thigh + shin;

                if (thigh > 40) {
                    showError("Thigh measurement is greater than 40cm. No Trexo device is suitable for this measurement.");
                    return;
                }

                if (shin < 20) {
                    showError("Shin measurement is less than 20cm. No Trexo device is suitable for this measurement.");
                    return;
                }

                resultsContainer.innerHTML = '';
                let matchingSizes = [];

                const sizes = [
                    {
                        name: "SMALL",
                        isMatch: (t, s) => (t >= 15 && t <= 21) && (s >= 21 && s <= 30),
                        maxLength: 52,
                        components: [
                            "Medium upper dynamic frame",
                            "Medium regular or Utility base",
                            "Small chest strap",
                            "Medium MPS",
                            "Guide rod",
                            "Small arm prompts"
                        ]
                    },
                    {
                        name: "MEDIUM",
                        isMatch: (t, s) => (t >= 19 && t <= 25) && (s >= 23 && s <= 30),
                        maxLength: 59,
                        components: [
                            "Medium upper dynamic frame",
                            "Medium regular or Utility base",
                            "Small chest strap",
                            "Medium MPS",
                            "Guide rod",
                            "Small arm prompts"
                        ]
                    },
                    {
                        name: "LARGE",
                        isMatch: (t, s) => (t >= 24 && t <= 34) && (s >= 30 && s <= 42),
                        maxLength: 80,
                        components: [
                            "large upper dynamic frame",
                            "large regular or utility base",
                            "medium or large MPS",
                            "medium chest strap",
                            "guide rod",
                            "Large arm prompts"
                        ]
                    },
                    {
                        name: "XL",
                        // Primary XL Rule
                        isMatch: (t, s) => (t >= 29 && t <= 39) && (s >= 33 && s <= 50),
                        maxLength: 93,
                        components: [
                            "Large MPS",
                            "XL upper dynamic frame",
                            "XL base frame",
                            "Large chest strap",
                            "Large arm prompts"
                        ]
                    },
                    {
                        name: "MULB",
                        isMatch: (t, s) => (t + s) >= 45 && (t + s) <= 54 && t >= 20,
                        maxLength: 63,
                        components: [
                            "medium upper dynamic frame",
                            "large regular or utility base",
                            "medium MPS",
                            "medium chest strap",
                            "guide rod",
                            "Small arm prompts"
                        ]
                    }
                ];

                // Check for all matching sizes (Primary Matches)
                sizes.forEach(size => {
                    if (size.isMatch(thigh, shin)) {
                        matchingSizes.push(size);
                    }
                });

                // --- Secondary Rules based on Total Measurement ---

                // Rule for Medium size based on sum with shin condition
                if (totalMeasurement >= 44 && totalMeasurement <= 55 && shin <= 29) {
                    const mediumSize = sizes.find(s => s.name === "MEDIUM");
                    if (mediumSize && !matchingSizes.some(s => s.name === "MEDIUM")) {
                        matchingSizes.push(mediumSize);
                    }
                }
                
                // Rule for Large size based on total sum
                if (totalMeasurement >= 53 && totalMeasurement <= 76) {
                    const largeSize = sizes.find(s => s.name === "LARGE");
                    if (largeSize && !matchingSizes.some(s => s.name === "LARGE")) {
                        matchingSizes.push(largeSize);
                    }
                }

                // Rule for XL size based on total sum
                const isXLSumRuleMet = totalMeasurement >= 60 && totalMeasurement <= 89 && thigh >= 28 && shin >= 34;

                if (isXLSumRuleMet) {
                    const xlSize = sizes.find(s => s.name === "XL");
                    if (xlSize && !matchingSizes.some(s => s.name === "XL")) {
                        matchingSizes.push(xlSize);
                    }
                }


                const displayUnit = currentUnit === 'cm' ? 'cm' : 'inches';

                if (matchingSizes.length > 0) {
                    // Filter out duplicates in case a size matched multiple times
                    // We use Map to quickly find unique objects by name
                    const uniqueMatchingSizesMap = new Map();
                    matchingSizes.forEach(size => uniqueMatchingSizesMap.set(size.name, size));
                    const uniqueMatchingSizes = Array.from(uniqueMatchingSizesMap.values());
                    
                    const sizeNames = uniqueMatchingSizes.map(size => size.name).join(', ');
                    resultsContainer.innerHTML = `
                        <p class="text-gray-900 font-medium mb-2">Based on the measurements, the patient can be fitted with the following Trexo device options:</p>
                        <p class="text-gray-900 font-medium mb-4">Matching Trexo Device Sizes: <span class="font-bold text-blue-600">${sizeNames}</span></p>
                    `;

                    uniqueMatchingSizes.forEach(size => {
                        let roomLeftForGrowth = size.maxLength - totalMeasurement;
                        let displayTotalMeasurement = totalMeasurement;

                        if (currentUnit === 'inches') {
                            roomLeftForGrowth = convertToInches(roomLeftForGrowth);
                            displayTotalMeasurement = convertToInches(displayTotalMeasurement);
                        }

                        const componentsList = size.components.map(item => `<li>${item}</li>`).join('');
                        resultsContainer.innerHTML += `
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <h3 class="text-lg font-semibold mb-2 text-gray-800">Components for Size ${size.name}:</h3>
                                <ul class="list-disc list-inside text-gray-700">
                                    <li>Room left for growth: <span class="font-bold">${roomLeftForGrowth.toFixed(2)} ${displayUnit}</span></li>
                                    ${componentsList}
                                </ul>
                            </div>
                        `;
                    });

                } else {
                    const displayTotalMeasurement = currentUnit === 'cm' ? totalMeasurement : convertToInches(totalMeasurement);
                    resultsContainer.innerHTML = `
                        <p class="text-gray-900 font-medium mb-2">No matching Trexo device size found for the entered measurements.</p>
                        <p class="text-gray-900 font-medium mt-4 pt-4 border-t-2 border-gray-200">The total combined measurement is <span class="font-bold text-blue-600">${displayTotalMeasurement.toFixed(2)} ${displayUnit}</span>.</p>
                    `;
                }

                showResults();
            }

            function showError(message) {
                errorMessage.classList.remove('hidden');
                errorText.textContent = message;
            }

            function hideError() {
                errorMessage.classList.add('hidden');
            }

            function showResults() {
                resultsSection.classList.remove('hidden');
            }

            function hideResults() {
                resultsSection.classList.add('hidden');
            }
        });
    </script>

</body>
</html>

